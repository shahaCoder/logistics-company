# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Migration Drift –≤ Production

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê

Prisma –æ–±–Ω–∞—Ä—É–∂–∏–ª drift - –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ:
- `20260113163833_add_truck_model`
- `20260113194651_node_modules_bin_prisma_generate`
- `20260113200404_add_samsara_fields`

**–ù–ï –î–ï–õ–ê–ô–¢–ï RESET** - —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!

## ‚úÖ –†–ï–®–ï–ù–ò–ï (–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ)

### –í–∞—Ä–∏–∞–Ω—Ç 1: Baseline –º–∏–≥—Ä–∞—Ü–∏–∏ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–°–æ–∑–¥–∞—Ç—å baseline –º–∏–≥—Ä–∞—Ü–∏—é** - –ø–æ–º–µ—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/backend/backend

# –°–æ–∑–¥–∞—Ç—å baseline - –ø–æ–º–µ—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ
npx prisma migrate resolve --applied 20260113163833_add_truck_model
npx prisma migrate resolve --applied 20260113194651_node_modules_bin_prisma_generate
npx prisma migrate resolve --applied 20260113200404_add_samsara_fields

# –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤
npx prisma migrate dev --name add_performance_indexes --create-only

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
cat prisma/migrations/*_add_performance_indexes/migration.sql

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate deploy
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å db push (–ë—ã—Å—Ç—Ä–æ, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é)

```bash
# –ü—Ä–æ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É —Å –ë–î –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
npx prisma db push

# –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å migrate dev
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é

1. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏
2. –î–æ–±–∞–≤–∏—Ç—å SQL –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤
3. –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—É—é

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

```bash
# 1. –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏)
# –ù–∞–∂–º–∏—Ç–µ N –∏–ª–∏ Ctrl+C

# 2. –ü–æ–º–µ—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ
npx prisma migrate resolve --applied 20260113163833_add_truck_model
npx prisma migrate resolve --applied 20260113194651_node_modules_bin_prisma_generate
npx prisma migrate resolve --applied 20260113200404_add_samsara_fields

# 3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤
npx prisma migrate dev --name add_performance_indexes --create-only

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (—É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å—ã)
cat prisma/migrations/*_add_performance_indexes/migration.sql

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate deploy

# 6. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate

# 7. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
npm run build
pm2 restart backend --update-env
```

## ‚ö†Ô∏è –í–ê–ñ–ù–û

- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `prisma migrate reset`** - —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `prisma migrate dev`** –±–µ–∑ `--create-only` –≤ production
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
- –î–µ–ª–∞–π—Ç–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –≤ production

## üìù –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è drift:
1. –î–æ–±–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ git (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `prisma migrate deploy` –≤ production (–Ω–µ `dev`)
