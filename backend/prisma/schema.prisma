// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ApplicationStatus {
  NEW
  IN_REVIEW
  APPROVED
  REJECTED
}

enum LegalConsentType {
  AUTHORIZATION
  ALCOHOL_DRUG
  SAFETY_PERFORMANCE
  PSP
  CLEARINGHOUSE
  MVR
}

enum AdminRole {
  SUPER_ADMIN
  MANAGER
  VIEWER
}

model DriverApplication {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  status       ApplicationStatus @default(NEW)
  reviewedAt   DateTime?
  reviewedBy   AdminUser?        @relation(fields: [reviewedById], references: [id])
  reviewedById String?

  internalNotes String?

  applicantIp  String?
  userAgent    String?

  // Identity
  firstName  String
  lastName   String
  dateOfBirth DateTime
  phone      String
  email      String

  currentAddressLine1 String
  currentCity         String
  currentState        String
  currentZip          String
  livedAtCurrentMoreThan3Years Boolean

  // SSN
  ssnEncrypted String
  ssnLast4     String

  // Driver Type
  applicantType String? // COMPANY_DRIVER or OWNER_OPERATOR
  truckYear     String? // For Owner Operators
  truckMake     String? // For Owner Operators

  // Alcohol & Drug Test
  alcoholDrugReturnToDuty Boolean? // Documentation of return-to-duty completion

  // Relations
  previousAddresses PreviousAddress[]
  license           DriverLicense?
  medicalCard       MedicalCard?
  employmentRecords EmploymentRecord[]
  legalConsents     LegalConsent[]

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Составной индекс для фильтрации по статусу + сортировки
  @@index([firstName, lastName]) // Для поиска по имени
  @@index([email]) // Для поиска по email
}

model PreviousAddress {
  id            String   @id @default(cuid())
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String

  addressLine1 String
  city         String
  state        String
  zip          String
  fromDate     DateTime?
  toDate       DateTime?

  @@index([applicationId])
}

model DriverLicense {
  id            String   @id @default(cuid())
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String   @unique

  licenseNumber String
  state         String
  class         String
  expiresAt     DateTime

  endorsements        String? // CSV: "H,N,X"
  hasOtherLicensesLast3Years Boolean
  otherLicensesJson   Json?

  frontImageUrl    String?
  frontImagePublicId String?
  backImageUrl     String?
  backImagePublicId  String?
}

model MedicalCard {
  id            String   @id @default(cuid())
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String   @unique

  expiresAt     DateTime?
  documentUrl   String?
  documentPublicId String?
}

model EmploymentRecord {
  id            String   @id @default(cuid())
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String

  employerName  String
  employerPhone String?
  employerFax   String?
  employerEmail String?

  addressLine1 String
  country      String  @default("US")
  city         String
  state        String
  zip          String?

  positionHeld String?
  dateFrom     DateTime?
  dateTo       DateTime?
  reasonForLeaving String?
  equipmentClass   String?

  wasSubjectToFMCSR    Boolean
  wasSafetySensitive   Boolean

  @@index([applicationId])
}

model LegalConsent {
  id            String   @id @default(cuid())
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String

  type       LegalConsentType
  accepted   Boolean
  signedAt   DateTime?
  signatureUrl      String?
  signaturePublicId String?
  formVersion       String?

  @@index([applicationId])
  @@index([applicationId, type])
}

model AdminUser {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?   // Display name for profile
  role         AdminRole @default(MANAGER)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  reviewedApplications DriverApplication[]
  refreshTokens        RefreshToken[]
}

model FreightRequest {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Contact Info
  companyName String?
  contactName String
  email       String
  phone       String
  isBroker    Boolean  @default(false)

  // Freight Details
  equipment       String?
  cargo           String?
  weight          String?
  pallets         String?
  pickupAddress   String
  pickupDate      String?
  pickupTime      String?
  deliveryAddress String?
  deliveryDate    String?
  deliveryTime    String?
  referenceId     String?
  notes           String?

  // Metadata
  applicantIp  String?
  userAgent    String?

  @@index([createdAt])
  @@index([email])
  @@index([isBroker, createdAt]) // Для фильтрации брокеров + сортировки
}

model ContactRequest {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String
  email       String
  message     String

  // Metadata
  applicantIp  String?
  userAgent    String?

  @@index([createdAt])
  @@index([email])
}

enum AuditAction {
  DECRYPT_SSN
  DELETE_APPLICATION
  UPDATE_STATUS
  LOGIN
  LOGOUT
  CREATE_APPLICATION
  VIEW_APPLICATION
  APPLICATION_EMAIL_SENT
  CREATE_ADMIN
  UPDATE_ADMIN
  UPDATE_PROFILE
}

model AuditLog {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())
  
  adminId     String?
  adminEmail  String?
  action      AuditAction
  resourceId  String?     // Application ID, etc.
  resourceType String?    // "DriverApplication", "FreightRequest", etc.
  details     Json?       // Additional context (IP, user agent, etc.)
  ipAddress   String?
  userAgent   String?

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([resourceId])
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  adminId     String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?
  
  admin       AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
  @@index([expiresAt])
}

model Truck {
  id                     String   @id @default(uuid())
  name                   String

  samsaraVehicleId       String?  @unique
  currentMiles           Int      @default(0)
  currentMilesUpdatedAt  DateTime?
  lastOilChangeMiles     Int?
  lastOilChangeAt        DateTime?
  oilChangeIntervalMiles Int      @default(15000)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([samsaraVehicleId]) // Для синхронизации с Samsara
  @@index([createdAt]) // Для сортировки
}


