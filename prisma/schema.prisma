generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DriverApplication {
  id                           String             @id @default(cuid())
  createdAt                    DateTime           @default(now())
  updatedAt                    DateTime           @updatedAt
  status                       ApplicationStatus  @default(NEW)
  reviewedAt                   DateTime?
  reviewedById                 String?
  internalNotes                String?
  applicantIp                  String?
  userAgent                    String?
  firstName                    String
  lastName                     String
  dateOfBirth                  DateTime
  phone                        String
  email                        String
  currentAddressLine1          String
  currentCity                  String
  currentState                 String
  currentZip                   String
  livedAtCurrentMoreThan3Years Boolean
  ssnEncrypted                 String
  ssnLast4                     String
  alcoholDrugReturnToDuty      Boolean?
  applicantType                String?
  truckMake                    String?
  truckYear                    String?
  reviewedBy                   AdminUser?         @relation(fields: [reviewedById], references: [id])
  license                      DriverLicense?
  employmentRecords            EmploymentRecord[]
  legalConsents                LegalConsent[]
  medicalCard                  MedicalCard?
  previousAddresses            PreviousAddress[]

  @@index([status])
  @@index([createdAt])
}

model PreviousAddress {
  id            String            @id @default(cuid())
  applicationId String
  addressLine1  String
  city          String
  state         String
  zip           String
  fromDate      DateTime?
  toDate        DateTime?
  application   DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model DriverLicense {
  id                         String            @id @default(cuid())
  applicationId              String            @unique
  licenseNumber              String
  state                      String
  class                      String
  expiresAt                  DateTime
  endorsements               String?
  hasOtherLicensesLast3Years Boolean
  otherLicensesJson          Json?
  frontImageUrl              String?
  frontImagePublicId         String?
  backImageUrl               String?
  backImagePublicId          String?
  application                DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model MedicalCard {
  id               String            @id @default(cuid())
  applicationId    String            @unique
  expiresAt        DateTime?
  documentUrl      String?
  documentPublicId String?
  application      DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model EmploymentRecord {
  id                 String            @id @default(cuid())
  applicationId      String
  employerName       String
  employerPhone      String?
  employerFax        String?
  employerEmail      String?
  addressLine1       String
  city               String
  state              String
  zip                String?
  positionHeld       String?
  dateFrom           DateTime?
  dateTo             DateTime?
  reasonForLeaving   String?
  equipmentClass     String?
  wasSubjectToFMCSR  Boolean
  wasSafetySensitive Boolean
  country            String            @default("US")
  application        DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model LegalConsent {
  id                String            @id @default(cuid())
  applicationId     String
  type              LegalConsentType
  accepted          Boolean
  signedAt          DateTime?
  signatureUrl      String?
  signaturePublicId String?
  formVersion       String?
  application       DriverApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([applicationId, type])
}

model AdminUser {
  id                   String              @id @default(cuid())
  email                String              @unique
  passwordHash         String
  role                 AdminRole           @default(MANAGER)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  reviewedApplications DriverApplication[]
  refreshTokens        RefreshToken[]
}

model FreightRequest {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  companyName     String?
  contactName     String
  email           String
  phone           String
  isBroker        Boolean  @default(false)
  equipment       String?
  cargo           String?
  weight          String?
  pallets         String?
  pickupAddress   String
  pickupDate      String?
  pickupTime      String?
  deliveryAddress String?
  deliveryDate    String?
  deliveryTime    String?
  referenceId     String?
  notes           String?
  applicantIp     String?
  userAgent       String?

  @@index([createdAt])
  @@index([email])
}

model ContactRequest {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  email       String
  message     String
  applicantIp String?
  userAgent   String?

  @@index([createdAt])
  @@index([email])
}

model AuditLog {
  id           String      @id @default(cuid())
  createdAt    DateTime    @default(now())
  adminId      String?
  adminEmail   String?
  action       AuditAction
  resourceId   String?
  resourceType String?
  details      Json?
  ipAddress    String?
  userAgent    String?

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([resourceId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  adminId   String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
  @@index([expiresAt])
}

enum ApplicationStatus {
  NEW
  IN_REVIEW
  APPROVED
  REJECTED
}

enum LegalConsentType {
  ALCOHOL_DRUG
  SAFETY_PERFORMANCE
  PSP
  CLEARINGHOUSE
  MVR
  AUTHORIZATION
}

enum AdminRole {
  SUPER_ADMIN
  MANAGER
  VIEWER
}

enum AuditAction {
  DECRYPT_SSN
  DELETE_APPLICATION
  UPDATE_STATUS
  LOGIN
  LOGOUT
  CREATE_APPLICATION
  VIEW_APPLICATION
  APPLICATION_EMAIL_SENT
}

model Truck {
  id                     String   @id @default(cuid())
  name                   String   @unique
  currentMiles           Int      @default(0)
  lastOilChangeMiles     Int      @default(0)
  oilChangeIntervalMiles Int      @default(10000)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([name])
}
